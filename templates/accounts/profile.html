{# Refactored: This template uses only the global base.html and global URL/template policy #}
{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
    <link as="style" href="{% static 'css/accounts.css' %}" onload="this.onload=null;this.rel='stylesheet'" rel="preload"/>
    <link as="style" href="{% static 'css/profile.css' %}" onload="this.onload=null;this.rel='stylesheet'" rel="preload"/>
    <noscript>
        <link rel="stylesheet" href="{% static 'css/accounts.css' %}">
        <link rel="stylesheet" href="{% static 'css/profile.css' %}">
    </noscript>
{% endblock %}

{% block content %}
<main class="profile-page">
    <div class="container py-4">
        <div class="row align-items-center mb-4">
            <div class="col-auto">
                <div class="position-relative d-inline-block">
                    {% if user.profile_picture %}
                        <img alt="{{ user.get_full_name|default:user.username }}" class="rounded-circle border" src="{{ user.profile_picture.url }}" style="width: 120px; height: 120px; object-fit: cover;" id="avatarPreview"/>
                    {% else %}
                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 120px; height: 120px; font-size: 2.5rem;" id="avatarPreview">
                            {{ user.get_initials|default:user.username|first|upper }}
                        </div>
                    {% endif %}
                    {% if request.user == user %}
                        <button class="btn btn-sm btn-primary position-absolute bottom-0 end-0 rounded-circle" style="transform: translate(25%, 25%);" data-bs-toggle="modal" data-bs-target="#avatarModal">
                            <i class="bi bi-camera"></i>
                        </button>
                    {% endif %}
                </div>

                <!-- Avatar Upload Modal -->
                <div class="modal fade" id="avatarModal" tabindex="-1" aria-labelledby="avatarModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="avatarModalLabel">Change Profile Picture</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form method="post" enctype="multipart/form-data" action="{% url 'accounts:upload_avatar' %}" id="avatarForm">
                                {% csrf_token %}
                                <div class="modal-body">
                                    <input class="form-control" type="file" name="profile_picture" id="avatarInput" accept="image/*" required>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Upload</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <h2 class="mb-1">{{ user.get_full_name|default:user.username }}</h2>
                <div class="text-muted">@{{ user.username }}</div>
                <div class="small text-muted">Member since {{ user.date_joined|date:"d M Y" }}{% if user.last_login %} · Last Active {{ user.last_login|timesince }} ago{% endif %}</div>
                <div class="mt-2">
                    {% if request.user == user %}
                        <a href="#" class="btn btn-primary btn-sm me-2" onclick="toggleEditProfile(true); return false;"><i class="bi bi-pencil-square me-1"></i> Edit Profile</a>
                        <a href="{% url 'accounts:change_password' %}" class="btn btn-outline-secondary btn-sm">Change Password</a>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- About Card -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card p-3 mb-3">
                    <h5 class="mb-3">About</h5>
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Full Name</dt>
                        <dd class="col-sm-8">{{ user.full_name }}</dd>
                        <dt class="col-sm-4">Username</dt>
                        <dd class="col-sm-8">@{{ user.username }}</dd>
                        {% if user.bio %}
                        <dt class="col-sm-4">Bio</dt>
                        <dd class="col-sm-8">{{ user.bio }}</dd>
                        {% endif %}
                        {% if user.gender %}
                        <dt class="col-sm-4">Gender</dt>
                        <dd class="col-sm-8">{{ user.get_gender_display }}</dd>
                        {% endif %}
                        {% if user.date_of_birth %}
                        <dt class="col-sm-4">Date of Birth</dt>
                        <dd class="col-sm-8">{{ user.date_of_birth|date:'F j, Y' }}</dd>
                        {% endif %}
                        {% if user.phone %}
                        <dt class="col-sm-4">Phone</dt>
                        <dd class="col-sm-8">{{ user.phone }}</dd>
                        {% endif %}
                        {% if user.address %}
                        <dt class="col-sm-4">Address</dt>
                        <dd class="col-sm-8">{{ user.address }}</dd>
                        {% endif %}
                        {% if user.city %}
                        <dt class="col-sm-4">City</dt>
                        <dd class="col-sm-8">{{ user.city }}</dd>
                        {% endif %}
                        {% if user.country %}
                        <dt class="col-sm-4">Country</dt>
                        <dd class="col-sm-8">{{ user.country }}</dd>
                        {% endif %}
                        <dt class="col-sm-4">Role</dt>
                        <dd class="col-sm-8">{{ user.get_role_display }}</dd>
                        <dt class="col-sm-4">Language</dt>
                        <dd class="col-sm-8">{{ user.get_language_preference_display }}</dd>
                        <dt class="col-sm-4">Timezone</dt>
                        <dd class="col-sm-8">{{ user.timezone }}</dd>
                        
                </div>
            </div>
        </div>

        <!-- Edit Profile Modal -->
        {% if request.user == user %}
        <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form method="post" action="{% url 'accounts:update_profile' %}">
                {% csrf_token %}
                <div class="modal-header">
                  <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="full_name" class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="full_name" name="full_name" value="{{ user.full_name }}" required>
                  </div>
                  <div class="mb-3">
                    <label for="bio" class="form-label">Bio</label>
                    <textarea class="form-control" id="bio" name="bio">{{ user.bio }}</textarea>
                  </div>
                  <div class="mb-3">
                    <label for="gender" class="form-label">Gender</label>
                    <select class="form-select" id="gender" name="gender">
                      <option value="">Select Gender</option>
                      <option value="male" {% if user.gender == 'male' %}selected{% endif %}>Male</option>
                      <option value="female" {% if user.gender == 'female' %}selected{% endif %}>Female</option>
                      <option value="other" {% if user.gender == 'other' %}selected{% endif %}>Other</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="date_of_birth" class="form-label">Date of Birth</label>
                    <input type="date" class="form-control" id="date_of_birth" name="date_of_birth" value="{{ user.date_of_birth|date:'Y-m-d' }}">
                  </div>
                  <div class="mb-3">
                    <label for="phone" class="form-label">Phone</label>
                    <input type="text" class="form-control" id="phone" name="phone" value="{{ user.phone }}">
                  </div>
                  <div class="mb-3">
                    <label for="address" class="form-label">Address</label>
                    <input type="text" class="form-control" id="address" name="address" value="{{ user.address }}">
                  </div>
                  <div class="mb-3">
                    <label for="city" class="form-label">City</label>
                    <input type="text" class="form-control" id="city" name="city" value="{{ user.city }}">
                  </div>
                  <div class="mb-3">
                    <label for="country" class="form-label">Country</label>
                    <input type="text" class="form-control" id="country" name="country" value="{{ user.country }}">
                  </div>
                  <div class="mb-3">
                    <label for="language_preference" class="form-label">Language</label>
                    <select class="form-select" id="language_preference" name="language_preference">
                      <option value="en" {% if user.language_preference == 'en' %}selected{% endif %}>English</option>
                      <option value="ne" {% if user.language_preference == 'ne' %}selected{% endif %}>Nepali</option>
                      <option value="hi" {% if user.language_preference == 'hi' %}selected{% endif %}>Hindi</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="timezone" class="form-label">Timezone</label>
                    <input type="text" class="form-control" id="timezone" name="timezone" value="{{ user.timezone }}">
                  </div>
                  <div class="mb-3">
                    <label for="profile_visibility" class="form-label">Profile Visibility</label>
                    <select class="form-select" id="profile_visibility" name="profile_visibility" required>
                      <option value="public" {% if user.profile_visibility == 'public' %}selected{% endif %}>Public</option>
                      <option value="private" {% if user.profile_visibility == 'private' %}selected{% endif %}>Private</option>
                    </select>
                  </div>
                  {% if user.role == 'caregiver' %}
                  <div class="mb-3">
                    <label for="rate_per_hour" class="form-label">Rate per Hour (NPR)</label>
                    <input type="number" class="form-control" id="rate_per_hour" name="rate_per_hour" value="{{ user.rate_per_hour }}">
                  </div>
                  {% endif %}
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <script>
          function toggleEditProfile(show) {
            var modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
            if (show) { modal.show(); }
          }
        </script>
        {% endif %}

            <div class="col-md-6 mb-3">
                <div class="card p-3 mb-3">
                    <h5 class="mb-2">Contact Information</h5>
                    <div><strong>Email:</strong> {{ user.email }}</div>
                    {% if user.phone %}<div><strong>Phone:</strong> {{ user.phone }}</div>{% endif %}
                    {% if user.address %}<div><strong>Address:</strong> {{ user.address }}</div>{% endif %}
                    {% if user.city %}<div><strong>City:</strong> {{ user.city }}</div>{% endif %}
                    {% if user.country %}<div><strong>Country:</strong> {{ user.country }}</div>{% endif %}
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card p-3">
                    <h5 class="mb-2">Account Status</h5>
                    <div><strong>Email Verified:</strong> {% if user.is_email_verified %}<span class="badge bg-success">Yes</span>{% else %}<span class="badge bg-secondary">No</span>{% endif %}</div>
                    <div><strong>Two-Factor Auth:</strong> {% if user.two_factor_enabled %}<span class="badge bg-success">Enabled</span>{% else %}<span class="badge bg-secondary">Not Set</span>{% endif %}</div>
                </div>
            </div>
        </div>
        {% if request.user == user %}
        <div class="row mb-4">
            <div class="col">
                <div class="card p-3 border-danger">
                    <h5 class="mb-2 text-danger">Danger Zone</h5>
                    <a href="{% url 'accounts:delete_account' %}" class="btn btn-danger">Delete Account</a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</main>
{% endblock %}
        {% if request.user.is_authenticated and request.user.is_family and request.user != user and user.is_caregiver %}
            {% if existing_request %}
                    {% if existing_request.status == 'pending' %}
                        <button class="btn btn-outline-secondary" disabled>
                            <i class="bi bi-hourglass me-1"></i> Request Sent
                        </button>
                    {% elif existing_request.status == 'accepted' %}
                        <button class="btn btn-outline-success" disabled>
                            <i class="bi bi-check-circle me-1"></i> Connected
                        </button>
                    {% else %}
                        <a href="{% url 'send_connection_request' user.id %}" class="btn btn-primary">
                            <i class="bi bi-person-plus me-1"></i> Connect
                        </a>
                    {% endif %}
                {% else %}
                    <a href="{% url 'send_connection_request' user.id %}" class="btn btn-primary">
                        <i class="bi bi-person-plus me-1"></i> Connect
                    </a>
                {% endif %}
        {% endif %}
    </div>
<!-- Badges -->
                        {% if badges %}
                        <div class="profile-badges mb-3">
                            {% for badge in badges %}
                            <span class="badge bg-{{ badge.color }}-subtle text-{{ badge.color }} border border-{{ badge.color }}-subtle" data-bs-placement="top" data-bs-toggle="tooltip" title="{{ badge.tooltip }}">
<i class="bi {{ badge.icon }} me-1"></i>{{ badge.label }}
                            </span>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- Stats -->
<div class="profile-stats">
<div class="stat-item">
<span class="stat-value">{{ user.date_joined|date:"d M Y" }}</span>
<span class="stat-label">Member Since</span>
</div>
                            {% if user.last_login %}
                            <div class="stat-item">
<span class="stat-value">{{ user.last_login|timesince }} ago</span>
<span class="stat-label">Last Active</span>
</div>
                            {% endif %}
                        </div>
</div>
</div>
<div class="col-auto">
<div class="profile-actions">
<a class="btn btn-outline-primary" href="{% url 'accounts:settings' %}">
<i class="bi bi-gear me-1"></i> Settings
                        </a>
<button class="btn btn-primary" onclick="toggleEditProfile(true)">
<i class="bi bi-pencil-square me-1"></i> Edit Profile
                        </button>
</div>
</div>
</div>
<!-- Account Deletion Warning -->
            {% if pending_deletion %}
            <div class="alert alert-danger mt-4" role="alert">
<div class="d-flex align-items-center">
<i class="bi bi-exclamation-triangle-fill me-2"></i>
<div>
<strong>Account Scheduled for Deletion</strong>
<p class="mb-0">Your account is scheduled to be deleted on {{ scheduled_deletion_at|date:"F j, Y \a\t g:i A" }}. 
                        <a class="alert-link" href="{% url 'accounts:cancel_account_deletion' %}">Cancel Deletion</a></p>
</div>
</div>
</div>
            {% endif %}
                        </div>
</div>
<!-- Main Content -->
<div class="profile-content mt-4">
<div class="row">
<!-- Left Column - Profile Info -->
<div class="col-lg-8">
<!-- About Section -->
<div class="card mb-4">
<div class="card-header d-flex justify-content-between align-items-center">
<h5 class="mb-0">About</h5>
<button class="btn btn-sm btn-outline-primary" onclick="toggleEditSection('about')">
<i class="bi bi-pencil-square me-1"></i> Edit
                            </button>
</div>
<div class="card-body">
<div id="about-view">
<div class="row">
<div class="col-md-6">
<div class="mb-3">
<h6 class="text-muted mb-2">Full Name</h6>
<p>{{ user.get_full_name|default:"Not provided" }}</p>
</div>
<div class="mb-3">
<h6 class="text-muted mb-2">Email</h6>
<p>{{ user.email }}</p>
</div>
                                        {% if user.phone %}
                                        <div class="mb-3">
<h6 class="text-muted mb-2">Phone</h6>
<p>{{ user.phone }}</p>
</div>
                                        {% endif %}
                                    </div>
<div class="col-md-6">
                                        {% if user.date_of_birth %}
                                        <div class="mb-3">
<h6 class="text-muted mb-2">Date of Birth</h6>
<p>{{ user.date_of_birth|date:"F j, Y" }}</p>
</div>
                                        {% endif %}
                                        {% if user.gender %}
                                        <div class="mb-3">
<h6 class="text-muted mb-2">Gender</h6>
<p>{{ user.get_gender_display }}</p>
</div>
                                        {% endif %}
                                    </div>
</div>
                                
                                {% if user.bio %}
                                <div class="mt-3">
<h6 class="text-muted mb-2">Bio</h6>
<p class="mb-0">{{ user.bio|linebreaksbr }}</p>
</div>
                                {% endif %}
                            </div>
<!-- Edit About Form -->
<div id="about-edit">
<form action="{% url 'accounts:update_profile' %}" id="about-form" method="post">
                                    {% csrf_token %}
                                    <div class="row">
<div class="col-md-6">
<div class="mb-3">
<label class="form-label" for="first_name">First Name</label>
<input class="form-control" id="first_name" name="first_name" type="text" value="{{ user.first_name }}"/>
</div>
</div>
<div class="col-md-6">
<div class="mb-3">
<label class="form-label" for="last_name">Last Name</label>
<input class="form-control" id="last_name" name="last_name" type="text" value="{{ user.last_name }}"/>
</div>
</div>
</div>
<div class="mb-3">
<label class="form-label" for="bio">Bio</label>
<textarea class="form-control" id="bio" name="bio" rows="3">{{ user.bio }}</textarea>
</div>
<div class="d-flex justify-content-end gap-2">
<button class="btn btn-outline-secondary" onclick="toggleEditSection('about')" type="button">
                                            Cancel
                                        </button>
<button class="btn btn-primary" type="submit">Save Changes</button>
</div>
</form>
</div>
</div>
</div>
<!-- Contact Information -->
<div class="card mb-4">
<div class="card-header d-flex justify-content-between align-items-center">
<h5 class="mb-0">Contact Information</h5>
<button class="btn btn-sm btn-outline-primary" onclick="toggleEditSection('contact')">
<i class="bi bi-pencil-square me-1"></i> Edit
                            </button>
</div>
<div class="card-body">
<div id="contact-view">
<div class="row">
<div class="col-md-6">
<div class="mb-3">
<h6 class="text-muted mb-2">Email</h6>
<p>{{ user.email }}</p>
</div>
                                        {% if user.phone %}
                                        <div class="mb-3">
<h6 class="text-muted mb-2">Phone</h6>
<p>{{ user.phone }}</p>
</div>
                                        {% endif %}
                                    </div>
<div class="col-md-6">
                                        {% if user.address %}
                                        <div class="mb-3">
<h6 class="text-muted mb-2">Address</h6>
<p>{{ user.address|linebreaksbr }}</p>
</div>
                                        {% endif %}
                                    </div>
</div>
</div>
<!-- Edit Contact Form -->
<div id="contact-edit">
<form action="{% url 'accounts:update_contact' %}" id="contact-form" method="post">
                                    {% csrf_token %}
                                    <div class="row">
<div class="col-md-6">
<div class="mb-3">
<label class="form-label" for="email">Email</label>
<input class="form-control" id="email" name="email" required="" type="email" value="{{ user.email }}"/>
</div>
<div class="mb-3">
<label class="form-label" for="phone">Phone</label>
<input class="form-control" id="phone" name="phone" type="tel" value="{{ user.phone|default:'' }}"/>
</div>
</div>
<div class="col-md-6">
<div class="mb-3">
<label class="form-label" for="address">Address</label>
<textarea class="form-control" id="address" name="address" rows="3">{{ user.address|default:'' }}</textarea>
</div>
</div>
</div>
<div class="d-flex justify-content-end gap-2">
<button class="btn btn-outline-secondary" onclick="toggleEditSection('contact')" type="button">
                                            Cancel
                                        </button>
<button class="btn btn-primary" type="submit">Save Changes</button>
</div>
</form>
</div>
</div>
</div>
<!-- Recent Activity -->
<div class="card mb-4">
<div class="card-header">
<h5 class="mb-0">Recent Activity</h5>
</div>
<div class="card-body">
                            {% if recent_activity %}
                                <div class="timeline">
                                    {% for activity in recent_activity %}
                                    <div class="timeline-item">
<div class="timeline-icon bg-{{ activity.type }}">
<i class="bi bi-{{ activity.icon }}"></i>
</div>
<div class="timeline-content">
<h6 class="mb-1">{{ activity.title }}</h6>
<p class="text-muted small mb-0">{{ activity.description }}</p>
<small class="text-muted">{{ activity.timestamp|timesince }} ago</small>
</div>
</div>
                                    {% endfor %}
                                </div>
<div class="text-center mt-3">
<a class="btn btn-outline-primary btn-sm" href="{% url 'accounts:activity' %}">
                                        View All Activity
                                    </a>
</div>
                            {% else %}
                                <div class="text-center py-4">
<i class="bi bi-activity fs-1 text-muted mb-3"></i>
<p class="text-muted">No recent activity to show</p>
</div>
                            {% endif %}
                        </div>
</div>
</div>
<!-- Right Column - Sidebar -->
<div class="col-lg-4">
<!-- Quick Links -->
<div class="card mb-4">
<div class="card-header">
<h5 class="mb-0">Quick Links</h5>
</div>
<div class="list-group list-group-flush">
<a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'accounts:change_password' %}">
<i class="bi bi-key me-2"></i> Change Password
                            </a>
<a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'accounts:privacy_settings' %}">
<i class="bi bi-shield-lock me-2"></i> Privacy Settings
                            </a>
<a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'accounts:notification_settings' %}">
<i class="bi bi-bell me-2"></i> Notification Preferences
                            </a>
<a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'accounts:connected_accounts' %}">
<i class="bi bi-link-45deg me-2"></i> Connected Accounts
                            </a>
</div>
</div>
<!-- Account Status -->
<div class="card mb-4">
<div class="card-header">
<h5 class="mb-0">Account Status</h5>
</div>
<div class="card-body">
<ul class="list-unstyled mb-0">
<li class="mb-2 d-flex justify-content-between">
<span>Email Verified</span>
                                    {% if user.email_verified %}
                                        <span class="badge bg-success">Verified</span>
                                    {% else %}
                                        <a class="badge bg-warning text-dark" href="{% url 'accounts:verify_email' %}">Verify Now</a>
                                    {% endif %}
                                </li>
<li class="mb-2 d-flex justify-content-between">
<span>Two-Factor Auth</span>
                                    {% if user.two_factor_enabled %}
                                        <span class="badge bg-success">Enabled</span>
                                    {% else %}
                                        <a class="badge bg-secondary" href="{% url 'accounts:setup_2fa' %}">Set Up</a>
                                    {% endif %}
                                </li>
<li class="d-flex justify-content-between">
<span>Member Since</span>
<span>{{ user.date_joined|date:"M d, Y" }}</span>
</li>
</ul>
</div>
</div>
<!-- Danger Zone -->
<div class="card border-danger">
<div class="card-header bg-danger text-white">
<h5 class="mb-0">Danger Zone</h5>
</div>
<div class="card-body">
<div class="d-grid gap-2">
<button class="btn btn-outline-danger" data-bs-target="#deactivateAccountModal" data-bs-toggle="modal">
<i class="bi bi-x-circle me-1"></i> Deactivate Account
                                </button>
<button class="btn btn-outline-danger" data-bs-target="#deleteAccountModal" data-bs-toggle="modal">
<i class="bi bi-trash me-1"></i> Delete Account
                                </button>
</div>
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="avatarInput" class="form-label">Choose an image (JPG, PNG, GIF, max 5MB)</label>
                        <input class="form-control" type="file" id="avatarInput" name="avatar" accept="image/jpeg,image/png,image/gif">
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="button" id="removeAvatarBtn" class="btn btn-outline-danger {% if not request.user.profile_picture %}d-none{% endif %}">
                            <i class="fas fa-trash-alt me-1"></i> Remove Picture
                        </button>
                        <button type="submit" class="btn btn-primary ms-auto">
                            <i class="fas fa-upload me-1"></i> Upload
                        </button>
                    </div>
                </form>
                <div id="avatarPreview" class="text-center mt-3">
                    {% if request.user.profile_picture %}
                        <img src="{{ request.user.profile_picture.url }}" alt="Current Profile Picture" class="img-fluid rounded-circle" style="max-width: 200px; max-height: 200px;">
                    {% else %}
                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 200px; height: 200px; margin: 0 auto;">
                            <i class="fas fa-user text-secondary" style="font-size: 80px;"></i>
                        </div>
                    {% endif %}
                </div>
                <div id="avatarMessage" class="mt-3 text-center"></div>
            </div>
        </div>
    </div>
</div>

<!-- Avatar Upload and Removal -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const avatarForm = document.getElementById('avatarForm');
    const avatarInput = document.getElementById('avatarInput');
    const removeAvatarBtn = document.getElementById('removeAvatarBtn');
    const avatarPreview = document.getElementById('avatarPreview');
    const avatarMessage = document.getElementById('avatarMessage');
    const submitBtn = avatarForm.querySelector('button[type="submit"]');

    // Handle form submission
    if (avatarForm) {
        avatarForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            if (avatarInput.files.length > 0) {
                formData.append('avatar', avatarInput.files[0]);
            } else {
                showAvatarMessage('Please select an image to upload.', 'error');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
            showAvatarMessage('Uploading your profile picture...', 'info');
            
            fetch('{% url "accounts:upload_avatar" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAvatarMessage(data.message, 'success');
                    // Update the avatar preview
                    if (data.url) {
                        const img = document.createElement('img');
                        img.src = data.url;
                        img.alt = 'Profile Picture';
                        img.className = 'img-fluid rounded-circle';
                        img.style.maxWidth = '200px';
                        img.style.maxHeight = '200px';
                        avatarPreview.innerHTML = '';
                        avatarPreview.appendChild(img);
                        
                        // Show the remove button
                        if (removeAvatarBtn) {
                            removeAvatarBtn.classList.remove('d-none');
                        }
                    }
                } else {
                    showAvatarMessage(data.error || 'An error occurred while uploading the image.', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAvatarMessage('An error occurred while uploading the image.', 'error');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-upload me-1"></i> Upload';
            });
        });
    }

    // Handle avatar removal
    if (removeAvatarBtn) {
        removeAvatarBtn.addEventListener('click', function() {
            if (!confirm('Are you sure you want to remove your profile picture?')) {
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Removing...';
            showAvatarMessage('Removing your profile picture...', 'info');
            
            fetch('{% url "accounts:upload_avatar" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ remove: true })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAvatarMessage(data.message, 'success');
                    // Reset the preview
                    avatarPreview.innerHTML = `
                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 200px; height: 200px; margin: 0 auto;">
                            <i class="fas fa-user text-secondary" style="font-size: 80px;"></i>
                        </div>`;
                    // Hide the remove button
                    this.classList.add('d-none');
                    // Clear the file input
                    avatarInput.value = '';
                } else {
                    showAvatarMessage(data.error || 'An error occurred while removing the profile picture.', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAvatarMessage('An error occurred while removing the profile picture.', 'error');
            })
            .finally(() => {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-trash-alt me-1"></i> Remove Picture';
            });
        });
    }

    // Show avatar upload messages
    function showAvatarMessage(message, type = 'info') {
        const messageElement = document.getElementById('avatarMessage');
        if (!messageElement) return;
        
        messageElement.textContent = message;
        messageElement.className = `mt-3 text-center text-${type === 'error' ? 'danger' : type}`;
        
        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
            setTimeout(() => {
                messageElement.textContent = '';
                messageElement.className = 'mt-3 text-center';
            }, 5000);
        }
    }

    // Preview image before upload
    if (avatarInput) {
        avatarInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = 'Preview';
                    img.className = 'img-fluid rounded-circle';
                    img.style.maxWidth = '200px';
                    img.style.maxHeight = '200px';
                    avatarPreview.innerHTML = '';
                    avatarPreview.appendChild(img);
                    
                    // Show the remove button when a new image is selected
                    if (removeAvatarBtn) {
                        removeAvatarBtn.classList.remove('d-none');
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
});

// Confirm account deactivation
document.addEventListener('DOMContentLoaded', function() {
    const confirmDeactivate = document.getElementById('confirmDeactivate');
    const confirmDeactivateBtn = document.getElementById('confirmDeactivateBtn');
    
    if (confirmDeactivate && confirmDeactivateBtn) {
        confirmDeactivate.addEventListener('change', function() {
            confirmDeactivateBtn.disabled = !this.checked;
        });
        
        confirmDeactivateBtn.addEventListener('click', function() {
            // Redirect to the account deactivation page
            window.location.href = '{% url "accounts:request_account_deletion" %}';
        });
    }
    
    // Confirm account deletion
    const confirmDelete = document.getElementById('confirmDelete');
    const deleteConfirmation = document.getElementById('deleteConfirmation');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    
    if (confirmDelete && deleteConfirmation && confirmDeleteBtn) {
        function validateDeleteConfirmation() {
            const isConfirmed = confirmDelete.checked;
            const isMatching = deleteConfirmation.value === 'DELETE';
            confirmDeleteBtn.disabled = !(isConfirmed && isMatching);
        }
        
        confirmDelete.addEventListener('change', validateDeleteConfirmation);
        deleteConfirmation.addEventListener('input', validateDeleteConfirmation);
        
        confirmDeleteBtn.addEventListener('click', function() {
            // Add your account deletion logic here
            window.location.href = '{% url "accounts:delete_account" %}';
        });
    }
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Show toast notification
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container');
    if (!toastContainer) return;
    
    const toastId = 'toast-' + Date.now();
    const iconMap = {
        'success': 'bi-check-circle-fill',
        'danger': 'bi-exclamation-triangle-fill',
        'warning': 'bi-exclamation-triangle-fill',
        'info': 'bi-info-circle-fill'
    };
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.role = 'alert';
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    toast.id = toastId;
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi ${iconMap[type] || 'bi-info-circle-fill'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: 5000 });
    bsToast.show();
    
    // Remove the toast from DOM after it's hidden
    toast.addEventListener('hidden.bs.toast', function() {
        toast.remove();
    });
{% if attending_events %}
<div class="mt-4">
    <hr/>
    <h5>Upcoming Events</h5>
    <ul class="list-group mb-3">
        {% for event in attending_events %}
        <li class="list-group-item">{{ event.title }} — {{ event.start_time }}</li>
        {% empty %}
        <li class="list-group-item text-muted">No upcoming events.</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<!-- Forum Activity -->
<div class="mt-4">
    <hr/>
    <h5>Forum Activity</h5>
    <div class="row">
        <div class="col-md-6">
            <h6>Recent Topics</h6>
            <ul class="list-group mb-3">
                {% for topic in recent_forum_topics %}
                <li class="list-group-item">
                    <a href="/forum/topic/{{ topic.id }}/">{{ topic.title }}</a>
                    <span class="text-muted small">({{ topic.created_at }})</span>
                </li>
                {% empty %}
                <li class="list-group-item text-muted">No topics.</li>
                {% endfor %}
            </ul>
        </div>
        <div class="col-md-6">
            <h6>Recent Replies</h6>
            <ul class="list-group">
                {% for reply in recent_forum_replies %}
                <li class="list-group-item">
                    <a href="/forum/topic/{{ reply.topic.id }}/#reply-{{ reply.id }}">Reply to: {{ reply.topic.title }}</a>
                    <span class="text-muted small">({{ reply.created_at }})</span>
                </li>
                {% empty %}
                <li class="list-group-item text-muted">No replies.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<!-- Profile Editing Section -->
<div class="mt-4">
    <hr/>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Profile Settings</h5>
    </div>
    
    {% if form %}
    <div id="profile-view-mode">
        <button class="btn btn-outline-primary float-end mb-3" onclick="toggleEditProfile(true)">
            <i class="bi bi-pencil"></i> Edit Profile
        </button>
        <div class="card">
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>Full Name:</strong> {{ user.full_name|default:'-' }}</li>
                    <li class="list-group-item"><strong>Username:</strong> {{ user.username }}</li>
                    <li class="list-group-item"><strong>Email:</strong> {{ user.email }}</li>
                    <li class="list-group-item"><strong>Bio:</strong> {{ user.bio|default:'-'|linebreaks }}</li>
                    <li class="list-group-item"><strong>Language Preference:</strong> {{ user.language_preference|default:'-' }}</li>
                    <li class="list-group-item"><strong>Timezone:</strong> {{ user.timezone|default:'-' }}</li>
                    <li class="list-group-item">
                        <strong>Email Notifications:</strong> 
                        <span class="badge bg-{{ user.email_notifications|yesno:'success,danger' }}">
                            {{ user.email_notifications|yesno:"Enabled,Disabled" }}
                        </span>
                    </li>
                    <li class="list-group-item">
                        <strong>Profile Visibility:</strong> 
                        <span class="badge bg-{% if user.profile_visibility == 'public' %}success{% else %}info{% endif %}">
                            {{ user.profile_visibility|capfirst }}
                        </span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div id="profile-edit-mode" style="display: none;">
        <div class="card">
            <div class="card-body">
                <form enctype="multipart/form-data" method="post">
                    {% csrf_token %}
                    {% if user.profile_picture %}
                    <div class="mb-3 text-center">
                        <img alt="Profile Picture Preview" class="img-thumbnail rounded-circle mb-2" 
                             src="{{ user.profile_picture.url }}" style="max-width: 150px; max-height: 150px;"/>
                    </div>
                    {% endif %}
                    {{ form.as_p }}
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary" onclick="toggleEditProfile(false)">
                            <i class="bi bi-x-circle me-1"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle me-1"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>Profile editing is currently not available.
    </div>
    {% endif %}
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<!-- Profile Picture Upload Modal -->
<div class="modal fade" id="uploadAvatarModal" tabindex="-1" aria-labelledby="uploadAvatarModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="avatarForm" enctype="multipart/form-data" method="post" action="{% url 'accounts:upload_avatar' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="uploadAvatarModalLabel">Upload Profile Picture</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <input class="form-control mb-3" type="file" id="avatarInput" name="avatar" accept="image/*" required>
          <div id="avatarPreview" class="mb-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Upload</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const avatarForm = document.getElementById('avatarForm');
    const avatarInput = document.getElementById('avatarInput');
    const avatarPreview = document.getElementById('avatarPreview');

    if (avatarForm) {
        avatarForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(avatarForm);

            fetch("{% url 'accounts:upload_avatar' %}", {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': avatarForm.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.url) {
                    // Update the avatar image on the page
                    document.querySelectorAll('.profile-avatar, #profileImagePreview').forEach(img => {
                        img.src = data.url;
                    });
                    // Optionally close modal
                    var modal = bootstrap.Modal.getInstance(document.getElementById('uploadAvatarModal'));
                    if (modal) modal.hide();
                } else {
                    alert(data.error || 'Failed to upload image.');
                }
            })
            .catch(() => {
                alert('Failed to upload image.');
            });
        });

        // Optional: Preview selected image before upload
        if (avatarInput && avatarPreview) {
            avatarInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (evt) {
                        avatarPreview.innerHTML = `<img src="${evt.target.result}" class="img-thumbnail rounded-circle" style="max-width: 120px; max-height: 120px;" />`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    avatarPreview.innerHTML = '';
                }
            });
        }
    }
});
</script>